/*
Deployment script for dbCars

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "dbCars"
:setvar DefaultFilePrefix "dbCars"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL13.SQLEXPRESS\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL13.SQLEXPRESS\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING ON,
                ANSI_WARNINGS ON,
                ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON,
                CURSOR_DEFAULT LOCAL,
                RECOVERY FULL 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET PAGE_VERIFY NONE 
            WITH ROLLBACK IMMEDIATE;
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET TARGET_RECOVERY_TIME = 0 SECONDS 
    WITH ROLLBACK IMMEDIATE;


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET QUERY_STORE (CLEANUP_POLICY = (STALE_QUERY_THRESHOLD_DAYS = 367)) 
            WITH ROLLBACK IMMEDIATE;
    END


GO
PRINT N'Creating [dbo].[__MigrationHistory]...';


GO
CREATE TABLE [dbo].[__MigrationHistory] (
    [MigrationId]    NVARCHAR (150)  NOT NULL,
    [ContextKey]     NVARCHAR (300)  NOT NULL,
    [Model]          VARBINARY (MAX) NOT NULL,
    [ProductVersion] NVARCHAR (32)   NOT NULL,
    CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY CLUSTERED ([MigrationId] ASC, [ContextKey] ASC)
);


GO
PRINT N'Creating [dbo].[Car]...';


GO
CREATE TABLE [dbo].[Car] (
    [Id]             BIGINT IDENTITY (1, 1) NOT NULL,
    [BrandId]        BIGINT NOT NULL,
    [ModelId]        BIGINT NOT NULL,
    [NumberId]       BIGINT NULL,
    [OwnerProfileId] BIGINT NULL,
    CONSTRAINT [PK_Car] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [dbo].[CarBrand]...';


GO
CREATE TABLE [dbo].[CarBrand] (
    [Id]         BIGINT        IDENTITY (1, 1) NOT NULL,
    [Name]       NVARCHAR (32) NOT NULL,
    [Visibility] BIT           NOT NULL,
    CONSTRAINT [PK_CarBrand] PRIMARY KEY CLUSTERED ([Name] ASC)
);


GO
PRINT N'Creating [dbo].[CarBrand].[U_Id]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [U_Id]
    ON [dbo].[CarBrand]([Id] ASC);


GO
PRINT N'Creating [dbo].[CarBrandModel]...';


GO
CREATE TABLE [dbo].[CarBrandModel] (
    [BrandId] BIGINT NOT NULL,
    [ModelId] BIGINT NOT NULL,
    CONSTRAINT [PK_CarBrandModel] PRIMARY KEY CLUSTERED ([BrandId] ASC, [ModelId] ASC)
);


GO
PRINT N'Creating [dbo].[CarModel]...';


GO
CREATE TABLE [dbo].[CarModel] (
    [Id]         BIGINT        IDENTITY (1, 1) NOT NULL,
    [Name]       NVARCHAR (32) NOT NULL,
    [Visibility] BIT           NOT NULL,
    CONSTRAINT [PK_CarModel] PRIMARY KEY CLUSTERED ([Name] ASC)
);


GO
PRINT N'Creating [dbo].[CarModel].[U_Id]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [U_Id]
    ON [dbo].[CarModel]([Id] ASC);


GO
PRINT N'Creating [dbo].[CarNumber]...';


GO
CREATE TABLE [dbo].[CarNumber] (
    [Id]     BIGINT        IDENTITY (1, 1) NOT NULL,
    [Number] NVARCHAR (16) NOT NULL,
    CONSTRAINT [PK_CarNumber] PRIMARY KEY CLUSTERED ([Number] ASC)
);


GO
PRINT N'Creating [dbo].[CarNumber].[U_Id]...';


GO
CREATE UNIQUE NONCLUSTERED INDEX [U_Id]
    ON [dbo].[CarNumber]([Id] ASC);


GO
PRINT N'Creating [dbo].[DisplayCarBrandModels]...';


GO
CREATE TABLE [dbo].[DisplayCarBrandModels] (
    [Id]         BIGINT         IDENTITY (1, 1) NOT NULL,
    [Visibility] BIT            NOT NULL,
    [Name]       NVARCHAR (MAX) NULL,
    CONSTRAINT [PK_dbo.DisplayCarBrandModels] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [dbo].[DisplayCarModelModels]...';


GO
CREATE TABLE [dbo].[DisplayCarModelModels] (
    [Id]   BIGINT         IDENTITY (1, 1) NOT NULL,
    [Name] NVARCHAR (MAX) NULL,
    CONSTRAINT [PK_dbo.DisplayCarModelModels] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [dbo].[DisplayCarModels]...';


GO
CREATE TABLE [dbo].[DisplayCarModels] (
    [Id]             BIGINT         IDENTITY (1, 1) NOT NULL,
    [OwnerProfileId] BIGINT         NULL,
    [Brand]          NVARCHAR (MAX) NULL,
    [Model]          NVARCHAR (MAX) NULL,
    [Number]         NVARCHAR (MAX) NULL,
    CONSTRAINT [PK_dbo.DisplayCarModels] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [dbo].[DF_CarBrand_Visibility]...';


GO
ALTER TABLE [dbo].[CarBrand]
    ADD CONSTRAINT [DF_CarBrand_Visibility] DEFAULT ((1)) FOR [Visibility];


GO
PRINT N'Creating [dbo].[DF_CarModel_Visibility]...';


GO
ALTER TABLE [dbo].[CarModel]
    ADD CONSTRAINT [DF_CarModel_Visibility] DEFAULT ((1)) FOR [Visibility];


GO
PRINT N'Creating [dbo].[FK_Car_CarBrandId]...';


GO
ALTER TABLE [dbo].[Car] WITH NOCHECK
    ADD CONSTRAINT [FK_Car_CarBrandId] FOREIGN KEY ([BrandId]) REFERENCES [dbo].[CarBrand] ([Id]) ON UPDATE CASCADE;


GO
PRINT N'Creating [dbo].[FK_Car_CarModelId]...';


GO
ALTER TABLE [dbo].[Car] WITH NOCHECK
    ADD CONSTRAINT [FK_Car_CarModelId] FOREIGN KEY ([ModelId]) REFERENCES [dbo].[CarModel] ([Id]);


GO
PRINT N'Creating [dbo].[FK_Car_CarNumberId]...';


GO
ALTER TABLE [dbo].[Car] WITH NOCHECK
    ADD CONSTRAINT [FK_Car_CarNumberId] FOREIGN KEY ([NumberId]) REFERENCES [dbo].[CarNumber] ([Id]);


GO
PRINT N'Creating [dbo].[FK_CarBrandModel_BrandId]...';


GO
ALTER TABLE [dbo].[CarBrandModel] WITH NOCHECK
    ADD CONSTRAINT [FK_CarBrandModel_BrandId] FOREIGN KEY ([BrandId]) REFERENCES [dbo].[CarBrand] ([Id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating [dbo].[FK_CarBrandModel_ModelId]...';


GO
ALTER TABLE [dbo].[CarBrandModel] WITH NOCHECK
    ADD CONSTRAINT [FK_CarBrandModel_ModelId] FOREIGN KEY ([ModelId]) REFERENCES [dbo].[CarModel] ([Id]) ON DELETE CASCADE ON UPDATE CASCADE;


GO
PRINT N'Creating [dbo].[AddCarBrand]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[AddCarBrand]
	@CarBrandName NVARCHAR(32)
AS
BEGIN
	IF NOT EXISTS (SELECT * FROM CarBrand WHERE Name = @CarBrandName)
	BEGIN
		INSERT INTO CarBrand (Name)
		VALUES (@CarBrandName);	
	END
	ELSE
	BEGIN
		UPDATE CarBrand SET Visibility = 1 WHERE Name = @CarBrandName;
	END;
END;
GO
PRINT N'Creating [dbo].[AddCarModel]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[AddCarModel]
	@CarBrandId BIGINT,
	@CarModelName NVARCHAR(32)
AS
BEGIN
	IF NOT EXISTS (SELECT * FROM CarModel WHERE Name = @CarModelName)
	BEGIN
		INSERT INTO CarModel (Name)
		VALUES (@CarModelName);	
	END
	ELSE
	BEGIN
		UPDATE CarModel SET Visibility = 1 WHERE Name = @CarModelName;
	END;
	
	IF EXISTS (SELECT * FROM CarBrand WHERE Id = @CarBrandId)
	BEGIN
		DECLARE @CarModelId BIGINT;
		SELECT @CarModelId = Id FROM CarModel WHERE Name = @CarModelName;
		IF NOT EXISTS (SELECT * FROM CarBrandModel WHERE BrandId = @CarBrandId AND ModelId = @CarModelId)
		BEGIN
			INSERT INTO CarBrandModel (BrandId, ModelId) VALUES (@CarBrandId, @CarModelId);
		END
	END;
	
END;
GO
PRINT N'Creating [dbo].[AddCarNumber]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[AddCarNumber]
	@CarNumber NVARCHAR(32)
AS
BEGIN
	IF NOT EXISTS (SELECT * FROM CarNumber WHERE Number = @CarNumber)
	BEGIN
		INSERT INTO CarNumber (Number)
		VALUES (@CarNumber);	
	END;
END;
GO
PRINT N'Creating [dbo].[DeleteCar]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[DeleteCar]
	@CarId BIGINT
AS
BEGIN
	DELETE FROM Car WHERE Id = @CarId;
END;
GO
PRINT N'Creating [dbo].[DeleteCarBrand]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[DeleteCarBrand]
	@CarBrandId BIGINT
AS
BEGIN
	DELETE FROM CarBrand WHERE Id = @CarBrandId;
END;
GO
PRINT N'Creating [dbo].[DeleteCarModel]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
create PROCEDURE [dbo].[DeleteCarModel]
	@CarModelId BIGINT
AS
BEGIN
	DELETE FROM CarModel WHERE Id = @CarModelId;
END;
GO
PRINT N'Creating [dbo].[GetCar]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetCar]
	@CarId BIGINT
AS
BEGIN
	SELECT SelectedCar.Id, SelectedCar.OwnerProfileId, CarBrand.Name AS Brand, CarModel.Name AS Model, CarNumber.Number AS Number
	FROM (SELECT * FROM Car WHERE Id = @CarId) AS SelectedCar
	LEFT JOIN CarBrand ON SelectedCar.BrandId = CarBrand.Id
	LEFT JOIN CarModel ON SelectedCar.ModelId = CarModel.Id
	LEFT JOIN CarNumber ON SelectedCar.NumberId = CarNumber.Id;
END;
GO
PRINT N'Creating [dbo].[GetCarBrandModels]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetCarBrandModels]
	@BrandId BIGINT
AS
BEGIN
	SELECT CarModel.Id, CarModel.Name
	FROM 
		(SELECT * FROM CarBrandModel WHERE BrandId = @BrandId) AS SelectedBrand
		INNER JOIN CarModel ON SelectedBrand.ModelId = CarModel.Id
	WHERE Visibility = 1
	ORdER BY CarModel.Name ASC;
END;
GO
PRINT N'Creating [dbo].[GetCarBrands]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetCarBrands]
AS
BEGIN
	SELECT Id, Name
	FROM CarBrand 
	WHERE Visibility = 1
	ORDER BY Name ASC;
END;
GO
PRINT N'Creating [dbo].[GetCars]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[GetCars]
AS
BEGIN
	SELECT Car.Id, Car.OwnerProfileId, CarBrand.Name AS Brand, CarModel.Name AS Model, CarNumber.Number AS Number
	FROM Car 
	LEFT JOIN CarBrand ON Car.BrandId = CarBrand.Id
	LEFT JOIN CarModel ON Car.ModelId = CarModel.Id
	LEFT JOIN CarNumber ON Car.NumberId = CarNumber.Id
	ORDER BY Car.Id DESC;
END;
GO
PRINT N'Creating [dbo].[UnvisibleCarBrand]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[UnvisibleCarBrand]
	@CarBrandId BIGINT
AS
BEGIN
	UPDATE CarBrand SET Visibility = 0 WHERE Id = @CarBrandId;
END;
GO
PRINT N'Creating [dbo].[UnvisibleCarModel]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[UnvisibleCarModel]
	@CarModelId BIGINT
AS
BEGIN
	UPDATE CarModel SET Visibility = 0 WHERE Id = @CarModelId;
END;
GO
PRINT N'Creating [dbo].[UpdateCar]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[UpdateCar]
	@CarId BIGINT,
	@OwnerProfileId BIGINT = NULL,
	@CarBrandId BIGINT,
	@CarModelId BIGINT,
	@CarNumber NVARCHAR(16) = NULL,
	@Result BIT OUTPUT
AS
BEGIN
	IF NOT EXISTS (SELECT * FROM Car 
	WHERE 
	Id = @CarId
	)
	BEGIN
		SET @Result = 0;
	END

	DECLARE @CarNumberId BIGINT;

	IF (@CarNumber <> '' AND @CarNumber IS NOT NULL)
	BEGIN
		EXEC dbo.AddCarNumber @CarNumber = @CarNumber;
		SELECT @CarNumberId = Id FROM CarNumber WHERE Number = @CarNumber;
	END
	
	UPDATE Car SET OwnerProfileId = @OwnerProfileId, BrandId = @CarBrandId, ModelId = @CarModelId, NumberId = @CarNumberId WHERE Id = @CarId;

	SET @Result = 1;
END;
GO
PRINT N'Creating [dbo].[AddCar]...';


GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[AddCar]
	@OwnerProfileId BIGINT = NULL,
	@CarBrandId BIGINT,
	@CarModelId BIGINT,
	@CarNumber NVARCHAR(16) = NULL,
	@ResultCarId BIGINT OUTPUT
AS
BEGIN
	DECLARE @CarNumberId BIGINT;

	IF (@CarNumber <> '' AND @CarNumber IS NOT NULL)
	BEGIN
		EXEC dbo.AddCarNumber @CarNumber = @CarNumber;
		SELECT @CarNumberId = Id FROM CarNumber WHERE Number = @CarNumber;
	END
	
	IF NOT EXISTS (SELECT * FROM Car 
	WHERE 
	BrandId = @CarBrandId AND
	ModelId = @CarModelId AND
	NumberId = @CarNumberId AND
	OwnerProfileId = @OwnerProfileId
	)
	BEGIN
		INSERT INTO Car(BrandId, ModelId, NumberId, OwnerProfileId)
		VALUES (@CarBrandId, @CarModelId, @CarNumberId, @OwnerProfileId);
		SET @ResultCarId = IDENT_CURRENT('Car');
	END
	ELSE
	BEGIN
		SELECT @ResultCarId = Id FROM Car 
	WHERE 
	BrandId = @CarBrandId AND
	ModelId = @CarModelId AND
	NumberId = @CarNumberId AND
	OwnerProfileId = @OwnerProfileId
	END
END;
GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Car] WITH CHECK CHECK CONSTRAINT [FK_Car_CarBrandId];

ALTER TABLE [dbo].[Car] WITH CHECK CHECK CONSTRAINT [FK_Car_CarModelId];

ALTER TABLE [dbo].[Car] WITH CHECK CHECK CONSTRAINT [FK_Car_CarNumberId];

ALTER TABLE [dbo].[CarBrandModel] WITH CHECK CHECK CONSTRAINT [FK_CarBrandModel_BrandId];

ALTER TABLE [dbo].[CarBrandModel] WITH CHECK CHECK CONSTRAINT [FK_CarBrandModel_ModelId];


GO
PRINT N'Update complete.';


GO
